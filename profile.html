<script type="module">
import { auth, db } from "./firebase.js";
import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

const profileAvatar = document.getElementById("profileAvatar");
const userName = document.getElementById("userName");
const userEmail = document.getElementById("userEmail");
const userPhone = document.getElementById("userPhone");
const userBalance = document.getElementById("userBalance");
const profileForm = document.getElementById("profileForm");

onAuthStateChanged(auth, async (user) => {
  if (user) {
    // 🔹 প্রথমে Auth থেকে লোড
    profileAvatar.src = user.photoURL || "https://via.placeholder.com/100";
    userName.value = user.displayName || "";
    userEmail.value = user.email || "";

    // 🔹 তারপর Firestore থেকে লোড (override করবে)
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      if (data.avatar) profileAvatar.src = data.avatar;
      if (data.name) userName.value = data.name;
      if (data.phone) userPhone.value = data.phone;
      if (typeof data.balance !== "undefined") userBalance.value = data.balance;
    }
  } else {
    window.location.href = "login.html";
  }
});

// 🔹 Save updates
profileForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return;

  const ref = doc(db, "users", user.uid);
  await updateDoc(ref, {
    name: userName.value,
    phone: userPhone.value,
    avatar: profileAvatar.src
  });

  alert("✅ Profile updated successfully!");
});
</script>