<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyhjOsIXNAkBglpRllt0OZIOJYpdB_9-8",
    authDomain: "diamond-recharge-f7f59.firebaseapp.com",
    projectId: "diamond-recharge-f7f59",
    storageBucket: "diamond-recharge-f7f59.firebasestorage.app",
    messagingSenderId: "657717928489",
    appId: "1:657717928489:web:70431ebc9afb7002d4b238",
    measurementId: "G-TDK78BQ8SQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUid = null;

  // Auth check
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // ✅ কেবল লগআউট অবস্থায় redirect হবে
      window.location.href = "login.html";
      return;
    }

    // ✅ লগইন থাকলে Firestore ডেটা লোড করো
    currentUid = user.uid;
    try {
      const docRef = doc(db, "users", currentUid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();

        // ফর্ম ফিল্ডে ডেটা বসানো
        document.getElementById("name").value = data.name || "";
        document.getElementById("email").value = data.email || user.email;
        document.getElementById("phone").value = data.phone || "";
        document.getElementById("avatar").value = data.avatar || "";
        document.getElementById("balance").value = data.balance || 0;
        document.getElementById("role").value = data.role || "user";
        document.getElementById("tier").value = data.tier || 0;
        document.getElementById("weekBoundary").value = data.weekBoundary || 0;
        document.getElementById("weeklyDiamonds").value = data.weeklyDiamonds || 0;
        document.getElementById("weeklyTotal").value = data.weeklyTotal || 0;
        document.getElementById("approved").checked = data.approved || false;
        document.getElementById("refundedOrders").value = data.refundedOrders ? data.refundedOrders.join(", ") : "";
      } else {
        console.warn("⚠️ User document not found in Firestore");
      }
    } catch (err) {
      console.error("Error loading Firestore user data:", err);
    }
  });

  // ✅ Update profile
  document.getElementById("profileForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUid) return;

    const docRef = doc(db, "users", currentUid);
    try {
      await updateDoc(docRef, {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        avatar: document.getElementById("avatar").value,
        balance: Number(document.getElementById("balance").value),
        role: document.getElementById("role").value,
        tier: Number(document.getElementById("tier").value),
        weekBoundary: Number(document.getElementById("weekBoundary").value),
        weeklyDiamonds: Number(document.getElementById("weeklyDiamonds").value),
        weeklyTotal: Number(document.getElementById("weeklyTotal").value),
        approved: document.getElementById("approved").checked,
        refundedOrders: document.getElementById("refundedOrders").value
          .split(",")
          .map(x => x.trim())
          .filter(x => x.length > 0),
      });
      document.getElementById("status").textContent = "✅ Profile updated successfully!";
      document.getElementById("status").style.color = "lightgreen";
    } catch (err) {
      console.error(err);
      document.getElementById("status").textContent = "❌ Error updating profile!";
      document.getElementById("status").style.color = "red";
    }
  });
</script>